---
title: "State Year 7 Report"
author: "Ian Combs"
date: "2024-1-08"
output: html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_doctument:
      toc: yes
      toc_depth: 3
---
```{r, setup, include = FALSE}
knitr::opts_chunk$set(warning = FALSE, fig.align = 'left')
knitr::opts_knit$set(root.dir = "../data")
options(width = 88)
library(magrittr)
```





### version: `r Sys.Date() %>% format(format="%B %d, %Y")`

<!-- this is where the DOI would go  [![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3675991.svg)](https://doi.org/10.5281/zenodo.3675991)
-->


#### [GitHub repository](https://github.com/icombs2017/nfwfEdrMonitoring){target="_blank"}
###

***
This is the working analysis pipeline to analyze data generated from outplant monitoring for the State Year 7 grant.

***

### All analyses performed with R version `r getRversion()`


# Basic setup of R environment
***
## Loading required packages
For the following analyses we will require the use of a number of different R packages. Most of which can be sourced from CRAN, but some must be downloaded from GitHub. We can use the following code to load in the packages and install any packages not previously installed in the R console. 


```{r,packages, include = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
if (!require("pacman")) install.packages("pacman")
pacman::p_load("ggplot2", "googlesheets4", "dplyr", "officer","reshape2", "stringr", "flextable", "gridExtra", "ggpubr", "Rmisc", "rcompanion", "RColorBrewer", "googledrive", "gdata", "readxl", "DescTools","patchwork", "FSA", "rstatix", "tidyverse", "lme4", 'PMCRMplus', "EnvStats", "emmeans", "MuMIn", "sjstats", "lmerTest", "gargle", "FSA", "vegan", "gtools", "lubridate", "data.table", "forcats")

```


# Importing Data
***
## We are downloading this dataset from our GoogleDrive folder. We will be using the package `googledrive`. Each GoogleDrive file has a unique ID that does not change throughout the lifespan of the document, even if the file name is changed. This ID is housed in the file's URL. 
Example: docs.google.com/spreadsheets/d/FILE_ID_GOES_HERE/other_information/. Below you will copy and paste that into the function `drive_download` within `as_id`. This will save the file locally in the specified path (in this case our data folder) and you will import the folder as you normally would. Downloading it this way decreases the potential human error when downloading, moving folders, renaming, saving etc and ensures that the most up to date file is being utilized. 

# Here we are importing data for our plug counts from google drive

```{r, outplantLoadingData, include = TRUE}

data <- drive_download(
 as_id("1b4IWK7tfSt3n8o8NlgJKSDoqj_QkHvKcaJBNz85RBv4"),
   path = "../data/outplantData.xlsx",
   overwrite = TRUE)

# The start and end dates for this reporting period
reportingStart <- as.Date("2023-07-01")
reportingEnd <- as.Date("2023-12-31")

# APAL Data
apalData <- read_excel("../data/outplantData.xlsx", sheet = "ex-situ Apal outplants")

# ACER Data
acerData <- read_excel("../data/outplantdata.xlsx", sheet = "in-situ Acer outplants", na = c("", "N/A", "NA"))

Y24Data <- read_excel("../data/outplantdata.xlsx", sheet = "2024-Present Lower Keys Outplan", na = c("", "N/A", "NA"))




```

# Sexual Recruit Outplants
## Doing some data wrangling to add the sexual recruits that were outplanted along with ACER and APAL, however we just want to capture the massives. 


```{r, SRwrangling, include =TRUE}
srdata <- drive_download(
 as_id("1f_9toNf8jaN3MbFsu7irqHi0dkIV0jHurAeRFtXi2yA"),
   path = "../data/SRoutplantData.xlsx",
   overwrite = TRUE)

srDataZ1 <- read_excel("../data/SRoutplantData.xlsx", sheet = "Site Z", na = c("", "N/A", "NA"))

srDataZ <- srDataZ1 %>% 
  select(`Outplant Date`,           
 `Site ID`,
  Species,
`Monitoring Date`,
 `# of frags in cluster`,
 `# Dead`,                  
 `# Missing`) %>% 
  mutate(
   ` Outplant Date` = as.Date(`Outplant Date`),
    `Site ID` = as.factor(`Site ID`),
    Species = as.factor(Species)) %>% 
  filter(!Species %in% c("APAL", "ACER")) %>% 
  droplevels() %>%
  dplyr:: rename(Date = `Outplant Date`,
                 `1-month Monitoring` = `Monitoring Date`) %>%
  group_by(Date, `1-month Monitoring`, `Site ID`) %>%
  dplyr::summarize(`# frags` = sum(`# of frags in cluster`),
                   totalDead = sum(`# Dead`),
                   totalMissing = sum(`# Missing`)) %>% 
  mutate(`1-month Survival` = (1-((totalDead+totalMissing)/`# frags`)), 
         `1-month % Dead` = (totalDead/`# frags`),
         `1-month % Missing` = (totalMissing/`# frags`),
         Deliverable = "State Yr7",
         `General Location` = "Site Z" ) %>% 
  select(Date, `General Location`, `Site ID`, Deliverable,`# frags`, `1-month Monitoring`, `1-month Survival`, `1-month % Dead`, `1-month % Missing`)
  


srDataP1 <- read_excel("../data/SRoutplantData.xlsx", sheet = "Site P", na = c("", "N/A", "NA"))

srDataP <- srDataP1 %>% 
   select(`Outplant Date`,           
 `Site ID`,
  Species,
`Monitoring Date`,
 `# of frags in cluster`,
 `# Dead`,                  
 `# Missing`) %>% 
  mutate(
   ` Outplant Date` = as.Date(`Outplant Date`),
    `Site ID` = as.factor(`Site ID`),
    Species = as.factor(Species)) %>% 
  filter(!Species %in% c("APAL", "ACER")) %>% 
  droplevels() %>%
  dplyr:: rename(Date = `Outplant Date`,
                 `1-month Monitoring` = `Monitoring Date`) %>%
  group_by(Date, `1-month Monitoring`, `Site ID`) %>%
  dplyr::summarize(`# frags` = sum(`# of frags in cluster`),
                   totalDead = sum(`# Dead`),
                   totalMissing = sum(`# Missing`)) %>% 
  mutate(`1-month Survival` = (1-((totalDead+totalMissing)/`# frags`)), 
         `1-month % Dead` = (totalDead/`# frags`),
         `1-month % Missing` = (totalMissing/`# frags`),
         Deliverable = "State Yr7",
         `General Location` = "Site P" ) %>% 
  select(Date, `General Location`, `Site ID`, Deliverable,`# frags`, `1-month Monitoring`, `1-month Survival`, `1-month % Dead`, `1-month % Missing`)


srData <- rbind(srDataP, srDataZ)






```














```{r, fragLoadingData, include = TRUE}
stateFrag <- read.csv("../data/stateFrag.csv")






 # data <- drive_download(
 # as_id("1u13FQRQ6u2vc4bRK6ZlrIGdhLjLvT_L2nAx7zcglWA0"),
 #   path = "../data/fraggingData.xlsx",
 #   overwrite = TRUE)

# Frag Data 2023
# frag23 <- read_excel("../data/fraggingData.xlsx", sheet = "Fragging 2023", na = "")
# 
# # Frag Data 2024
# frag24 <- read_excel("../data/fraggingData.xlsx", sheet = "Fragging 2024", na = "")

```


# Fragging Summary
### We are going to report on our fragging outputs during the reporting period, but first we need to do some data wrangling.

```{r, fragDataWrangling, include = TRUE}


# 
# stateFrag <- stateFrag1 %>% 
#   select(`Reporting Period`,
#          `Date Cut`, 
#          Species, 
#          `New Genotype`, 
#          `New Frag Count`) %>% 
#   filter(`Date Cut` >= "2023-07-01" & `Date Cut` <= "2024-06-30") %>%
#   filter(`Reporting Period` %in% c("State Yr7")) %>%
#   mutate_at(c("Reporting Period", 
#          "Date Cut", 
#           "Species",
#           "New Genotype"), as.factor) %>%
#   mutate_at(c("Date Cut"), as.Date) %>% 
#   na.omit() 
#   # mutate(MonthYear = format(`Date Cut`, "%b %Y")) %>% 
#   # group_by(MonthYear) %>% 
#   # mutate(MonthCount = sum(`New Frag Count`))

fragMonth <- stateFrag %>% 
  select(Date.Cut, Species, New.Genotype, New.Frag.Count) %>% 
  mutate(Date = as.Date(Date.Cut ,format = "%m/%d/%Y")) %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Genotype = as.factor(New.Genotype)) %>% 
  select(Date, Species, Genotype, New.Frag.Count) %>% 
  mutate(Month = format(Date, "%Y-%m")) %>% 
  mutate(Month = as.factor(Month)) %>% 
  group_by(Month, Species) %>% 
  dplyr::summarize(totalFrag = sum(New.Frag.Count))

summary<-fragMonth %>% 
  group_by(Species) %>% 
  dplyr::summarize(totalFrag = sum(totalFrag))

# write.csv(stateFrag, "../data/stateFrag.csv", row.names = FALSE)



```

```{r, fraggingNumbersPlot, include = TRUE}
reportingPeriod <- as.factor(c("2023-07", "2023-08", "2023-09", "2023-10", "2023-11", "2023-12", "2024-01", "2024-02", "2024-03", "2024-04", "2024-05", "2024-06"))

# Create a summary dataframe with all combinations of "Month" and "Species"

fragOutputPlot1 <- ggplot(fragMonth, aes(x = Month, y = totalFrag, fill = Species)) +
  geom_bar(stat = "identity")+
  ggtitle("Fragments Produced")+
  xlab("")+
  ylab("Number of Fragments Produced")+
  scale_y_continuous(limits = c(0, 6000), breaks = seq(0, 6000, by = 1000))
  

fragOutputPlot <- fragOutputPlot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(size = 40, angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 20, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Facets <- this will be removed if you don't have facets!
    strip.text = element_text(size = 50, face = 'bold'),
    strip.background = element_rect(fill = "#D1D0D0"),
    # Legend
    legend.title = element_text(size = 40, face = "bold"),
    legend.text = element_text(size = 30, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = '#f3f3f3'),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Text
    text = element_text(size=20, color="black"))


ggsave("../figures/fragOutputPlot.png", plot = fragOutputPlot, width = 20, height = 15, units = 'in', dpi = 600)


```


#Fragging Table

```{r, fraggingTable, include = TRUE}
# Wrangling for the table


fragTab1 <- stateFrag %>% 
  select(Date.Cut, Species, New.Genotype, New.Frag.Count) %>% 
  mutate(Date = as.Date(Date.Cut ,format = "%m/%d/%Y")) %>% 
  mutate(Species = as.factor(Species)) %>% 
  mutate(Genotype = as.factor(New.Genotype)) %>% 
  select(Date, Species, Genotype, New.Frag.Count) %>% 
  mutate(Month = format(Date, "%Y-%m"))  %>%  
  # group_by(Month, Species, Genotype) %>% 
  # dplyr::summarize(totalFrag = sum(New.Frag.Count)) %>% 
  # select(Month, Species, Genotype, totalFrag) %>% 
  # distinct() %>% 
  group_by(Month, Species) %>%
  mutate(Genos = n_distinct(Genotype)) %>% 
  ungroup() %>% 
  select(Month, Species, New.Frag.Count, Genos) %>%
  group_by(Month, Species)%>%
  group_by(Month, Species, Genos) %>%
  dplyr::summarize(totalFrag = sum(New.Frag.Count)) 

# Making the table
fragTab <- fragTab1 %>% 
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "totalFrag", value = as_paragraph("Number of Microfragments\nPropagated")) %>%
  flextable::compose(part = "header", j = "Genos", value = as_paragraph("Number of Genotypes\nPropagated")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", j = "totalFrag") %>% 
  align(align = 'center', j = "Genos") %>% 
  set_table_properties(width = 0.8, align = "center", layout = "autofit") %>%  
  add_footer_row(values = list(Month = "Totals:", "", totalFrag = sum(fragTab1$totalFrag), Genos = sum(fragTab1$Genos)), colwidths = c(1, 1, 1, 1)) %>%
  align(align = 'center', part = "footer")

totals <- c("Totals:", "", sum(fragTab1$totalFrag), sum(fragTab1$Genos))

fragDoc = read_docx()
fragDoc = body_add_flextable(fragDoc, value = fragTab)
print(fragDoc, target = "../tables/fragOutputTable.docx")
fragTab


```



# APAL Monitoring summary

## Time to do some data wrangling for the APAL dataset. Since we only care about the NFWF Deliverables right now, we are going to filter the data set to just include those given to the grant *NFWF-EDR*. Also including a fixed string called apalDeliverables and apalCumulativeDeliverables that includes what each deliverable is each year and cumulatively by year.


```{r, apalDataWrangling, include = TRUE}


outplantAPAL <- apalData %>% 
  select(Year, 
         Date, 
         `Site ID`, 
         Deliverable, 
         `# plugs`, 
         `1-month Monitoring`,
         `1-month Survival`, 
         `1-month % Dead`, 
         `1-month % Missing`,
         `1-month % Plot Survival`, 
         `% of Plots with Partial Mortality`,
         `Avg. % Partial Mortality within Affected Plots`,
         `12-month Monitoring`,                           
         `12-month Survival`,                             
         `12-month % Dead`,                               
         `12-month % Missing`,                            
         `12-month % Plot Survival`) %>% 
  filter(Deliverable %in% c("NFWF-EDR Yr3", "NFWF-EDR", "NFWF-EDR Yr2")) %>% 
  mutate_at(c("Year", 
         "Site ID", 
        "Deliverable"), as.factor) %>% 
  droplevels() %>% 
  mutate(cum_sum = cumsum(`# plugs`)) %>% 
  mutate(Date = as.Date(Date, "%m %d %Y"))


outplantByYearAP <- outplantAPAL %>% 
  select(Year, 
         Date, 
         `Site ID`, 
         Deliverable, 
         `# plugs`) %>% 
  group_by(Deliverable) %>% 
  mutate(totalOutplanted = sum(`# plugs`))

apalDeliverables <- c(5000, 8000, 11000)




apalCumulativeDeliverables <- c(5000, 13000, 24000)



```

# Plotting APAL Outplant Numbers

## Plotting outplant numbers for all APAL over the course of the three years.


```{r, apalOutplantCumulativePlot, include = TRUE}

outplantAPALplot1<- ggplot(outplantAPAL, aes(x = Date, y = cum_sum))+
  geom_line(aes(color = "Fragments Outplanted", linetype = 'solid'), linewidth = 3)+
  geom_hline(aes(yintercept = apalCumulativeDeliverables[1], linetype = 'Year 1 Outplant Goal (In-situ Apal)', color = 'Year 1 Outplant Goal (In-situ Apal)'), linewidth = 3) +
  geom_hline(aes(yintercept = apalCumulativeDeliverables[2], linetype = 'Year 2 Outplant Goal (In-situ Apal)', color = 'Year 2 Outplant Goal (In-situ Apal)'), linewidth = 3) +
  geom_hline(aes(yintercept = apalCumulativeDeliverables[3], linetype = 'Year 3 Outplant Goal (In-situ Apal', color = 'Year 3 Outplant Goal (In-situ Apal)'), linewidth = 3) +
  geom_segment(aes(x = as.Date("2023-05-09"), y = 19363,
                   xend = as.Date("2024-02-01"), yend = 19363),
               linetype = 'solid', color = 'blue', size = 3)+ # remove this with full dataset
  scale_y_continuous(limits = c(0, 30000), breaks = seq(0, 30000, by = 2000))+
  ggtitle(expression("Number of "*italic("Acropora palmata")*" Fragments Outplanted per Year"))+
  xlab(" ")+
  ylab("Number of fragments outplanted")+
  scale_color_manual(values = c('blue', 'grey', "green3", 'gold'), name = " ") +
  scale_linetype_manual(name = " ", values = c('solid', 'dashed', 'dashed', 'dashed'), guide = "none")+
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month")




outplantAPALplot <- outplantAPALplot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 20, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 20, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 20, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 20, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))


ggsave("../figures/cumulativeAPALoutplantPlot.png", plot =outplantAPALplot, width = 20, height = 15, units = 'in', dpi = 600)

```
## Outplant Table
Creating a table for number of outplant events


```{r, apalOutplantTable, include = TRUE}
# Wrangling for the table

outplantAPALtab1 <- apalData %>%
  select(Date, `Site ID`, `# plugs`, Lat, Long, ...28:ncol(.), Deliverable) %>%
  mutate(numberOfGenotypes = rowSums(!is.na(select(., ...28:ncol(.))))) %>%  # this counts all of the "geno types used" section in this and adds them to a column that is "number of Genotypes"
  mutate(Date = as.Date(Date)) %>% 
  filter(Deliverable %in% c("NFWF-EDR Yr3", "NFWF-EDR", "NFWF-EDR Yr2")) %>% 
  select(Date, `Site ID`, `# plugs`, Lat, Long, numberOfGenotypes)
  

# Making the table
outplantAPALtab <- outplantAPALtab1 %>% 
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "Date", value = as_paragraph("Outplant Date")) %>%
  flextable::compose(part = "header", j = "# plugs", value = as_paragraph("Number of Corals")) %>%
  flextable::compose(part = "header", j = "Lat", value = as_paragraph("Latitude")) %>% 
  flextable::compose(part = "header", j = "Long", value = as_paragraph("Longitude")) %>%   flextable::compose(part = "header", j = "numberOfGenotypes", value = as_paragraph("Number of Genotypes")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", j = "# plugs") %>% 
  align(align = 'center', j = "numberOfGenotypes") %>% 
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%  
  add_footer_row(values = list(Date = "Totals:", "", "", "", `# plugs` = sum(outplantAPALtab1$`# plugs`), numberOfGenotypes = sum(outplantAPALtab1$numberOfGenotypes)), colwidths = c(1, 1, 1, 1, 1, 1)) %>%
  align(align = 'center', part = "footer")

totals <- c("Totals:", "", sum(outplantAPALtab1$`# plugs`), sum(outplantAPALtab1$numberOfGenotypes))

outplantAPALDoc = read_docx()
outplantAPALDoc = body_add_flextable(outplantAPALDoc, value = outplantAPALtab)
print(outplantAPALDoc, target = "../tables/outplantAPALtable.docx")
outplantAPALtab








```

# APAL One Month Monitoring
We're going to wrangle the data so we can plot one month survival




## APAL One Month Data Wrangling
```{r, oneMonthDataWranglingAPAL, include = TRUE}

myColors <- c("red", "yellow", "green")
OneMoSurvivalAPAL2 <- outplantAPAL %>% 
  # mutate_at(c("1-month Survival", "1-month % Dead", "1-month % Missing", "12-month Survival", "12-month % Dead", "12-month % Missing"), as.double) %>%
    pivot_longer(cols = c("1-month Survival", "1-month % Dead", "1-month % Missing"), names_to = "1 month", values_to = "1 mo percentage") %>%
  # pivot_longer(cols = c("12-month Survival", "12-month % Dead", "12-month % Missing"), names_to = "12 month", values_to = "12 mo percentage") %>% 
  select(Year, Date, `Site ID`, Deliverable, `1 month`, `1 mo percentage`) %>% 
  mutate_at(c("1 month"), as.factor) %>% 
  mutate(`Site ID` = factor(`Site ID`, levels = mixedsort(levels(`Site ID`))))


# OneMoSurvivalAPAL2$`Site ID` <- factor(OneMoSurvivalAPAL2$`Site ID`, levels = mixedsort(levels(OneMoSurvivalAPAL2$`Site ID`)))




# %>% 
#   filter(between(Date, as.Date("2023-07-01"), as.Date("2024-02-01")))

```


## APAL One Month Survival Plot
Plotting One Month Survival Using a stacked bar graph
```{r, oneMonthSurvivalPlotAPAL, include = TRUE}

apal1MoSurvivalPlot1<- ggplot(OneMoSurvivalAPAL2, aes(x = `Site ID`, y = `1 mo percentage`, fill = `1 month`, color = I('black')))+
  geom_bar(position = "stack", stat = 'identity', width = 1)+
  ggtitle(expression("1 Month Percent Surival of "*italic("Acropora palmata")*"  Outplants"))+
  xlab("Site")+
  ylab("% Survival")+
  scale_fill_manual(values = myColors)

apal1MoSurvivalPlot <- apal1MoSurvivalPlot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(size = 30, angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 40, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_blank(),
    legend.text = element_text(size = 40, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))




ggsave("../figures/oneMonthSurvivalAPAL.png", plot =apal1MoSurvivalPlot, width = 20, height = 15, units = 'in', dpi = 600)



```

## APAL One Month Monitoring Table
```{r, apalOneMonthTable, include = TRUE}

# Wrangling for the table
oneMonthAPALtab1 <- outplantAPAL %>%
  select(`Site ID`, `1-month Monitoring?`, `# plugs`, `1-month Survival`, `1-month % Dead`, `1-month % Missing`, `1-month % Plot Survival`, Deliverable) %>%
  mutate(`1-month Monitoring?` = as.Date(`1-month Monitoring?`, `1-month % Plot Survival` = as.numeric(`1-month % Plot Survival`))) %>% 
  filter(Deliverable %in% c("NFWF-EDR Yr3", "NFWF-EDR", "NFWF-EDR Yr2")) %>% 
  select(`Site ID`, `1-month Monitoring?`, `# plugs`, `1-month Survival`, `1-month % Dead`, `1-month % Missing`, `1-month % Plot Survival`) %>% 
  mutate_at(vars(`1-month Survival`, `1-month % Dead`, `1-month % Missing`, `1-month % Plot Survival`), ~ round(. * 100, 2))




# Making the table
oneMonthAPALtab <- oneMonthAPALtab1 %>% 
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "1-month Monitoring?", value = as_paragraph("1-Month Monitoring Date")) %>%
  flextable::compose(part = "header", j = "# plugs", value = as_paragraph("Number of Corals Outplanted")) %>%
  flextable::compose(part = "header", j = "1-month Survival", value = as_paragraph("1-month Survival")) %>% 
  flextable::compose(part = "header", j = "1-month % Dead", value = as_paragraph("1-Month % Dead")) %>% 
  flextable::compose(part = "header", j = "1-month % Missing", value = as_paragraph("1-Month % Missing ")) %>%
  flextable::compose(part = "header", j = "1-month % Plot Survival", value = as_paragraph("1-Month % Cluster Survival ")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", j = "# plugs") %>% 
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%  
  add_footer_row(values = 
    list(
      `Site ID` = "Averages:",
      "",
      "",
      `1-month Survival` = round(mean(oneMonthAPALtab1$`1-month Survival`), 2),
      `1-month % Dead` = round(mean(oneMonthAPALtab1$`1-month % Dead`), 2),
      `1-month % Missing` = round(mean(oneMonthAPALtab1$`1-month % Missing`), 2),
      `1-month % Plot Survival` = round(mean(oneMonthAPALtab1$`1-month % Plot Survival`),2)),
    colwidths = c(1, 1, 1, 1, 1, 1, 1))

 
averages <- c("Averages:", "", "", mean(oneMonthAPALtab1$`1-month Survival`), mean(oneMonthAPALtab1$`1-month % Dead`), mean(oneMonthAPALtab1$`1-month % Missing`), mean(oneMonthAPALtab1$`1-month % Plot Survival`))

oneMonthAPALDoc = read_docx()
oneMonthAPALDoc = body_add_flextable(oneMonthAPALDoc, value = oneMonthAPALtab)
print(oneMonthAPALDoc, target = "../tables/oneMonthAPALtable.docx")
oneMonthAPALtab

```





# APAL 12 Month Monitoring

## APAL 12mo monitoring

```{r, 12MonthDataWranglingAPAL, include = TRUE}

twelveMoSurvivalAPAL2 <- outplantAPAL %>% 
  mutate_at(c("1-month Survival", "1-month % Dead", "1-month % Missing", "12-month Survival", "12-month % Dead", "12-month % Missing"), as.double) %>% 
  # pivot_longer(cols = c("1-month Survival", "1-month % Dead", "1-month % Missing"), names_to = "1 month", values_to = "1 mo percentage") %>%
  pivot_longer(cols = c("12-month Survival", "12-month % Dead", "12-month % Missing"), names_to = "12 month", values_to = "12 mo percentage") %>% 
  select(Year, Date, `Site ID`, Deliverable, `12 month`, `12 mo percentage`) %>% 
  na.omit() %>% 
  mutate_at(c("12 month"), as.factor) %>% 
    mutate(`Site ID` = factor(`Site ID`, levels = mixedsort(levels(`Site ID`))))
# %>% 
#   filter(between(Date, as.Date("2023-07-01"), as.Date("2024-02-01")))
 


```

## APAL 12 Month Survival Plot
```{r, 12MonthSurvivalPlotAPAL, include = TRUE}
apal12MoSurvivalPlot1<- ggplot(twelveMoSurvivalAPAL2, aes(x = `Site ID`, y = `12 mo percentage`, fill = `12 month`, color = I('black')))+
  geom_bar(position = "stack", stat = 'identity', width = 1)+
ggtitle(expression("12 Month Percent Surival of "*italic("Acropora palmata")*" Outplants"))+
  xlab("Year")+
  ylab("Percent Survival")+
  scale_fill_manual(values = myColors)



apal12MoSurvivalPlot <- apal12MoSurvivalPlot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(size = 30, angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 40, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_blank(),
    legend.text = element_text(size = 40, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))

ggsave("../figures/12MonthSurvivalPlotAPAL.png", plot =apal12MoSurvivalPlot, width = 20, height = 15, units = 'in', dpi = 600)



```


## APAL 12 Month Monitoring Table
```{r, apalTwelveMonthTable, include = TRUE}

# Wrangling for the table
twelveMonthAPALtab1 <- outplantAPAL %>%
  select(`Site ID`, `12-month Monitoring?`, `# plugs`, `12-month Survival`, `12-month % Dead`, `12-month % Missing`, `12-month % Plot Survival`, Deliverable) %>%
  mutate(`12-month Monitoring?` = as.Date(`12-month Monitoring?`, `12-month % Plot Survival` = as.numeric(`12-month % Plot Survival`))) %>% 
  filter(Deliverable %in% c("NFWF-EDR Yr3", "NFWF-EDR", "NFWF-EDR Yr2")) %>% 
  select(`Site ID`, `12-month Monitoring?`, `# plugs`, `12-month Survival`, `12-month % Dead`, `12-month % Missing`, `12-month % Plot Survival`) %>% 
  mutate_at(vars(`12-month Survival`, `12-month % Dead`, `12-month % Missing`, `12-month % Plot Survival`), ~ round(. * 100, 2)) %>% 
  na.omit()




# Making the table
twelveMonthAPALtab <- twelveMonthAPALtab1 %>% 
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "12-month Monitoring?", value = as_paragraph("12-Month Monitoring Date")) %>%
  flextable::compose(part = "header", j = "# plugs", value = as_paragraph("Number of Corals Outplanted")) %>%
  flextable::compose(part = "header", j = "12-month Survival", value = as_paragraph("12-month Survival")) %>% 
  flextable::compose(part = "header", j = "12-month % Dead", value = as_paragraph("12-Month % Dead")) %>% 
  flextable::compose(part = "header", j = "12-month % Missing", value = as_paragraph("12-Month % Missing ")) %>%
  flextable::compose(part = "header", j = "12-month % Plot Survival", value = as_paragraph("12-Month % Cluster Survival ")) %>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", j = "# plugs") %>% 
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%  
  add_footer_row(values = 
    list(
      `Site ID` = "Averages:",
      "",
      "",
      `12-month Survival` = round(mean(twelveMonthAPALtab1$`12-month Survival`), 2),
      `12-month % Dead` = round(mean(twelveMonthAPALtab1$`12-month % Dead`), 2),
      `12-month % Missing` = round(mean(twelveMonthAPALtab1$`12-month % Missing`), 2),
      `12-month % Plot Survival` = round(mean(twelveMonthAPALtab1$`12-month % Plot Survival`),2)),
    colwidths = c(1, 1, 1, 1, 1, 1, 1))

 
averages <- c("Averages:", "", "", mean(twelveMonthAPALtab1$`12-month Survival`), mean(twelveMonthAPALtab1$`12-month % Dead`), mean(twelveMonthAPALtab1$`12-month % Missing`), mean(twelveMonthAPALtab1$`12-month % Plot Survival`))

twelveMonthAPALDoc = read_docx()
twelveMonthAPALDoc = body_add_flextable(twelveMonthAPALDoc, value = twelveMonthAPALtab)
print(twelveMonthAPALDoc, target = "../tables/twelveMonthAPALtable.docx")
twelveMonthAPALtab

```



# 2024 Monitoring

## Time to do some data wrangling for the State Year 7 dataset. Since we only care about the State Year 7 Deliverables right now, we are going to filter the data set to just include those given to the grant *State Yr7*. Also including a fixed string called *deliverables* and *cumulativeDeliverables* that includes what each deliverable is each year and cumulatively by year.



```{r, apalDataWrangling, include = TRUE}
srData # data from our sexual recruits

outplantY24 <- Y24Data %>% 
  select( Date,
         `General Location`,
         `Site ID`, 
         Deliverable, 
         `# frags`, 
         `1-month Monitoring`,
         `1-month Survival`, 
         `1-month % Dead`, 
         `1-month % Missing`,
         # `1-month % Plot Survival` 
         # `12-month Monitoring`,                           
         # `12-month Survival`,                             
         # `12-month % Dead`,                               
         # `12-month % Missing`,                            
         # `12-month % Plot Survival`) %>%)
  ) %>% 
  filter(Deliverable %in% c("State Yr7")) %>% 
  filter(`Site ID` %in% c("HH_3", "JP_1")) %>% 
  mutate_at(c(#"Year", 
         "Site ID", 
        "Deliverable"), as.factor) %>% 
  droplevels() %>% 
  # mutate(cum_sum = cumsum(`# frags`)) %>%
  mutate(Date = as.Date(Date, "%m %d %Y"))

outplantData1 <- rbind(srData,outplantY24) %>% 
  as.tibble()
 
  
outplantData <- outplantData1 %>%
    mutate(cum_sum = base::cumsum(`# frags`)) %>%
    mutate(Date = as.Date(Date))
  
write.csv(outplantData, "../tables/outplantY24.csv", row.names = FALSE)


deliverables <- c(2000)

cumulativeDeliverables <- c(2000)



```


# Plotting 2024 Outplant Numbers

## Plotting outplant numbers for all 2024 corals.


```{r, 2024OutplantCumulativePlot, include = TRUE}

outplantY24plot1<- ggplot(outplantData, aes(x = Date, y = cum_sum))+
  geom_line(aes(color = "Fragments Outplanted", linetype = 'solid'), linewidth = 3)+
  geom_hline(aes(yintercept = cumulativeDeliverables, linetype = 'State Year 7 Outplant Goal', color = 'State Year 7 Outplant Goal'), linewidth = 3)+
  scale_y_continuous(limits = c(0, 3000), breaks = seq(0, 3000, by = 500))+
  ggtitle(expression("Coral Fragments Outplanted for State Year 7"))+
  xlab(" ")+
  ylab("Number of fragments outplanted")+
  scale_color_manual(values = c('blue', 'black'), name = " ") +
  scale_linetype_manual(name = " ", values = c('solid', 'dashed', 'dashed', 'dashed'), guide = "none")




outplantY24plot <- outplantY24plot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(size = 20, angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 20, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 20, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 20, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 20, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))


ggsave("../figures/cumulativeY24outplantPlot.png", plot = outplantY24plot, width = 20, height = 15, units = 'in', dpi = 600)

```
## 2024 Outplant Table
Creating a table for number of outplant events


```{r, y24OutplantTable, include = TRUE}






# Wrangling for the table

outplantY24tab1 <- Y24Data %>%
  select( Date,
         `General Location`,
         `Site ID`, 
         Deliverable,
         Lat,
         Long,
         `# frags`, 
         `1-month Monitoring`,
         `1-month Survival`, 
         `1-month % Dead`, 
         `1-month % Missing`,
         # `1-month % Plot Survival` 
         # `12-month Monitoring`,                           
         # `12-month Survival`,                             
         # `12-month % Dead`,                               
         # `12-month % Missing`,                            
         # `12-month % Plot Survival`) %>%)
  ) %>% 
  mutate(Date = as.Date(Date)) %>% 
  filter(Deliverable %in% c("State Yr7")) %>% 
  select(Date,
         `General Location`,
         `Site ID`, 
         Lat,
         Long,
         `# frags`, 
         `1-month Monitoring`,
         `1-month Survival`, 
         `1-month % Dead`, 
         `1-month % Missing`)
  

# Making the table
outplantY24tab <- outplantData %>% 
  flextable() %>%
  set_header_labels(Data.set = "Data set") %>% 
  flextable::compose(part = "header", j = "Date", value = as_paragraph("Outplant Date")) %>%
  flextable::compose(part = "header", j = "# frags", value = as_paragraph("Number of Corals")) %>%
  flextable::compose(part = "header", j = "Lat", value = as_paragraph("Latitude")) %>% 
  flextable::compose(part = "header", j = "Long", value = as_paragraph("Longitude"))%>%
  autofit() %>%
  flextable::font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 12, part = "all") %>%
  bold(part = "header") %>%
  align(align = "center", j = "# frags") %>% 
  set_table_properties(width = 1, align = "center", layout = "autofit") %>%  
  add_footer_row(values = list(`Outplant Date` = "Totals:"," ","","","","","","","",
                               `Number of Corals` = sum(outplantY24tab1$`# frags`)), colwidths = c(1,1,1,1,1,1,1,1,1,1))
  
  
  
  
 
totals <- c("Totals:", "", sum(outplantY24tab1$`# plugs`))

outplantY24Doc = read_docx()
outplantY24Doc = body_add_flextable(outplantY24Doc, value = outplantY24tab)
print(outplantY24Doc, target = "../tables/outplantY24table.docx")
outplantY24tab








```
## Y24 One Month Survival Plot
Plotting One Month Survival Using a stacked bar graph
```{r, oneMonthSurvivalPlotY24, include = TRUE}

myColors <- c("red3", "yellow3", "green3")


y24OutplantPlotData <- outplantData %>% 
pivot_longer(cols = c("1-month Survival", "1-month % Dead", "1-month % Missing"), names_to = "1 month", values_to = "1 mo percentage")


y241MoSurvivalPlot1<- ggplot(y24OutplantPlotData, aes(x = `Site ID`, y = `1 mo percentage`, fill = `1 month`, color = I('black')))+
  geom_bar(position = "stack", stat = 'identity', width = 1)+
  ggtitle(expression("1 Month Percent Surival of Coral Outplants"))+
  xlab("Site")+
  ylab("% Survival")+
  scale_fill_manual(values = myColors)

y241MoSurvivalPlot <- y241MoSurvivalPlot1 + theme(
    # Title
    plot.title = element_text(size = 40, face = "bold"),
    # X Axis
    axis.text.x = element_text(size = 30, angle = 45, hjust = 1),  
    axis.title.x = element_text(size = 40, face = "bold"),
    # Y Axis
    axis.title.y = element_text(size = 40, face = "bold"),
    axis.text.y = element_text(colour = "black", size = 30, face = "bold"),
    # Axis Lines and Ticks
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(color="black"),
    # Legend
    legend.title = element_blank(),
    legend.text = element_text(size = 40, face = "bold", colour = "black"),
    legend.position = "bottom",
    # Grid and Background
    panel.grid.major = element_line(size = 0.3, linetype = 'solid', colour = "black"),
    panel.background = element_rect(fill = 'white'),
    # Text
    text = element_text(size=20, color="black"))




ggsave("../figures/oneMonthSurvivalY24.png", plot =y241MoSurvivalPlot, width = 20, height = 15, units = 'in', dpi = 600)



```

